<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Editor Ultimate</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        theme: {
                            base: 'var(--bg-base)',
                            editor: 'var(--bg-editor)',
                            preview: 'var(--bg-preview)',
                            toolbar: 'var(--bg-toolbar)',
                            border: 'var(--border-color)',
                            text: 'var(--text-main)',
                            muted: 'var(--text-muted)',
                            accent: 'var(--accent-color)',
                            toolbarText: 'var(--text-toolbar)',
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- DOMPurify -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    
    <!-- Highlight.js -->
    <link id="highlight-css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Mermaid.js -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.min.js"></script>
    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    
    <!-- GitHub Markdown CSS (IDè¿½åŠ : å‹•çš„åˆ‡æ›¿ç”¨) -->
    <link id="github-markdown-css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.0/github-markdown-light.min.css">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* =========================================
           ãƒ†ãƒ¼ãƒå®šç¾© (CSS Variables)
           ========================================= */
        :root {
            /* Light (Default) */
            --bg-base: #f3f4f6;
            --bg-editor: #f9fafb;
            --bg-preview: #ffffff;
            --bg-toolbar: #1f2937;
            --bg-code: #f6f8fa;
            --border-color: #e5e7eb;
            --text-main: #111827;
            --text-muted: #6b7280;
            --text-toolbar: #f3f4f6;
            --accent-color: #3b82f6;
            --scrollbar-thumb: #c1c1c1;
            --scrollbar-hover: #a8a8a8;
        }

        /* Dark */
        [data-theme="dark"] {
            --bg-base: #0d1117;
            --bg-editor: #0d1117;
            --bg-preview: #0d1117;
            --bg-toolbar: #161b22;
            --bg-code: #161b22;
            --border-color: #30363d;
            --text-main: #c9d1d9;
            --text-muted: #8b949e;
            --text-toolbar: #c9d1d9;
            --accent-color: #58a6ff;
            --scrollbar-thumb: #484f58;
            --scrollbar-hover: #586069;
        }

        /* Solarized Light */
        [data-theme="solarized-light"] {
            --bg-base: #fdf6e3;
            --bg-editor: #fdf6e3;
            --bg-preview: #fdf6e3;
            --bg-toolbar: #eee8d5;
            --bg-code: #fdf6e3;
            --border-color: #d3d7cf;
            --text-main: #586e75;
            --text-muted: #93a1a1;
            --text-toolbar: #586e75;
            --accent-color: #2aa198;
            --scrollbar-thumb: #93a1a1;
            --scrollbar-hover: #839496;
        }

        /* Dracula */
        [data-theme="dracula"] {
            --bg-base: #282a36;
            --bg-editor: #282a36;
            --bg-preview: #282a36;
            --bg-toolbar: #44475a;
            --bg-code: #282a36;
            --border-color: #6272a4;
            --text-main: #f8f8f2;
            --text-muted: #6272a4;
            --text-toolbar: #f8f8f2;
            --accent-color: #ff79c6;
            --scrollbar-thumb: #6272a4;
            --scrollbar-hover: #bd93f9;
        }

        /* Cobalt (Blue) */
        [data-theme="cobalt"] {
            --bg-base: #002240;
            --bg-editor: #002240;
            --bg-preview: #002240;
            --bg-toolbar: #001f3f;
            --bg-code: #002240;
            --border-color: #194060;
            --text-main: #ffffff;
            --text-muted: #80a0c0;
            --text-toolbar: #ffffff;
            --accent-color: #ffc107;
            --scrollbar-thumb: #194060;
            --scrollbar-hover: #ffc107;
        }

        /* =========================================
           åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«
           ========================================= */
        body {
            color: var(--text-main);
            background-color: var(--bg-base);
            transition: background-color 0.3s, color 0.3s;
        }

        .editor-area {
            font-family: 'Menlo', 'Monaco', 'Consolas', 'Courier New', monospace;
            line-height: 1.6;
            tab-size: 4;
            color: var(--text-main);
            caret-color: var(--text-main);
        }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--scrollbar-hover); }

        .toolbar-btn:hover { background-color: rgba(128,128,128,0.2); }
        .view-btn.active { background-color: var(--bg-base); color: var(--text-main); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        @media print {
            header, .editor-pane, .status-bar, #toast { display: none !important; }
            .preview-pane { width: 100% !important; border: none !important; height: auto !important; overflow: visible !important; }
            body, main { height: auto !important; overflow: visible !important; background: white !important; }
            .markdown-body { padding: 0 !important; max-width: 100% !important; color: black !important; background: white !important; }
        }

        /* =========================================
           Markdown Body & Code Style
           ========================================= */
        .markdown-body {
            background-color: var(--bg-preview) !important;
            color: var(--text-main) !important;
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* * ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ 
         * ãƒ†ãƒ¼ãƒå¤‰æ•°ã‚’å„ªå…ˆã—ã¤ã¤ã€Highlight.jsã®ã‚«ãƒ©ãƒ¼ãƒªãƒ³ã‚°ã‚’é˜»å®³ã—ãªã„è¨­å®š
         */
        .markdown-body pre {
            background-color: var(--bg-code) !important;
            border: 1px solid var(--border-color);
            color: inherit; /* æ–‡å­—è‰²ã¯å­è¦ç´ (code.hljs)ã¾ãŸã¯è¦ªã®è¨­å®šã«å¾“ã† */
        }
        
        /* Highlight.jsã®èƒŒæ™¯ã‚’é€æ˜ã«ã—ã¦ã€preã‚¿ã‚°ã®èƒŒæ™¯è‰²ã‚’æ´»ã‹ã™ */
        .markdown-body pre code.hljs {
            background-color: transparent !important;
            padding: 0;
            color: inherit; /* ã“ã‚Œã‚’è¨­å®šã—ãªã„ã¨Github CSSã®é»’è‰²ãŒå„ªå…ˆã•ã‚Œã‚‹å ´åˆãŒã‚ã‚‹ */
        }

        /* ãƒ†ãƒ¼ãƒ–ãƒ«ãªã©ã®å¾®èª¿æ•´ */
        [data-theme="dark"] .markdown-body table tr,
        [data-theme="dracula"] .markdown-body table tr,
        [data-theme="cobalt"] .markdown-body table tr { background-color: var(--bg-preview); border-top-color: var(--border-color); }
        
        [data-theme="dark"] .markdown-body table tr:nth-child(2n),
        [data-theme="dracula"] .markdown-body table tr:nth-child(2n),
        [data-theme="cobalt"] .markdown-body table tr:nth-child(2n) { background-color: rgba(128,128,128,0.1); }
        
        [data-theme="dark"] .markdown-body table th, 
        [data-theme="dark"] .markdown-body table td,
        [data-theme="dracula"] .markdown-body table th,
        [data-theme="dracula"] .markdown-body table td,
        [data-theme="cobalt"] .markdown-body table th,
        [data-theme="cobalt"] .markdown-body table td { border-color: var(--border-color); }

        [data-theme="solarized-light"] .markdown-body blockquote,
        [data-theme="solarized-light"] .markdown-body table tr { background-color: transparent; }

        .mermaid { display: flex; justify-content: center; margin: 20px 0; background: transparent; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="bg-theme-toolbar border-b border-theme-border p-2 flex justify-between items-center shadow-sm z-20 shrink-0 transition-colors duration-300">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2 text-theme-toolbarText px-2">
                <i class="fa-brands fa-markdown text-2xl" style="color: var(--accent-color)"></i>
                <h1 class="font-bold tracking-tight hidden sm:block">MD Ultimate</h1>
            </div>
            
            <div class="h-6 w-px bg-theme-border mx-1 hidden md:block"></div>
            <div class="flex gap-1 overflow-x-auto no-scrollbar items-center text-theme-toolbarText">
                <button onclick="insertFormat('bold')" class="toolbar-btn p-1.5 rounded" title="å¤ªå­—"><i class="fa-solid fa-bold"></i></button>
                <button onclick="insertFormat('italic')" class="toolbar-btn p-1.5 rounded" title="æ–œä½“"><i class="fa-solid fa-italic"></i></button>
                <button onclick="insertFormat('strike')" class="toolbar-btn p-1.5 rounded" title="æ‰“ã¡æ¶ˆã—ç·š"><i class="fa-solid fa-strikethrough"></i></button>
                <div class="h-4 w-px bg-theme-border mx-1"></div>
                <button onclick="insertFormat('h1')" class="toolbar-btn p-1.5 rounded font-bold text-xs" title="è¦‹å‡ºã—1">H1</button>
                <button onclick="insertFormat('h2')" class="toolbar-btn p-1.5 rounded font-bold text-xs" title="è¦‹å‡ºã—2">H2</button>
                <button onclick="insertFormat('h3')" class="toolbar-btn p-1.5 rounded font-bold text-xs" title="è¦‹å‡ºã—3">H3</button>
                <div class="h-4 w-px bg-theme-border mx-1"></div>
                <button onclick="insertFormat('list')" class="toolbar-btn p-1.5 rounded" title="ãƒªã‚¹ãƒˆ"><i class="fa-solid fa-list-ul"></i></button>
                <button onclick="insertFormat('check')" class="toolbar-btn p-1.5 rounded" title="ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ"><i class="fa-regular fa-square-check"></i></button>
                <button onclick="insertFormat('quote')" class="toolbar-btn p-1.5 rounded" title="å¼•ç”¨"><i class="fa-solid fa-quote-right"></i></button>
                <div class="h-4 w-px bg-theme-border mx-1"></div>
                <button onclick="insertFormat('code')" class="toolbar-btn p-1.5 rounded" title="ã‚³ãƒ¼ãƒ‰"><i class="fa-solid fa-code"></i></button>
                <button onclick="insertFormat('link')" class="toolbar-btn p-1.5 rounded" title="ãƒªãƒ³ã‚¯"><i class="fa-solid fa-link"></i></button>
                <button onclick="insertFormat('image')" class="toolbar-btn p-1.5 rounded" title="ç”»åƒ"><i class="fa-regular fa-image"></i></button>
                <button onclick="insertFormat('table')" class="toolbar-btn p-1.5 rounded" title="ãƒ†ãƒ¼ãƒ–ãƒ«"><i class="fa-solid fa-table"></i></button>
                <button onclick="insertFormat('math')" class="toolbar-btn p-1.5 rounded" title="æ•°å¼"><i class="fa-solid fa-square-root-variable"></i></button>
            </div>
        </div>

        <div class="flex items-center gap-2">
            <div class="bg-theme-base border border-theme-border rounded p-0.5 flex text-theme-muted">
                <button onclick="setViewMode('editor')" class="view-btn p-1.5 rounded text-xs hover:text-theme-text transition" title="ã‚¨ãƒ‡ã‚£ã‚¿ã®ã¿"><i class="fa-solid fa-pen-nib"></i></button>
                <button onclick="setViewMode('split')" class="view-btn p-1.5 rounded text-xs hover:text-theme-text transition" title="åˆ†å‰²"><i class="fa-solid fa-columns"></i></button>
                <button onclick="setViewMode('preview')" class="view-btn p-1.5 rounded text-xs hover:text-theme-text transition" title="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã¿"><i class="fa-solid fa-eye"></i></button>
            </div>

            <div class="relative">
                <select id="theme-selector" onchange="changeTheme(this.value)" class="appearance-none bg-theme-base text-theme-text text-xs border border-theme-border rounded pl-2 pr-6 py-1.5 focus:outline-none focus:border-theme-accent cursor-pointer">
                    <option value="light">Light</option>
                    <option value="dark">Dark</option>
                    <option value="solarized-light">Solarized</option>
                    <option value="dracula">Dracula</option>
                    <option value="cobalt">Cobalt</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-theme-text">
                    <i class="fa-solid fa-chevron-down text-[10px]"></i>
                </div>
            </div>
            
            <button onclick="exportPDF()" class="p-2 text-theme-toolbarText hover:bg-white/10 rounded transition" title="PDFä¿å­˜/å°åˆ·">
                <i class="fa-solid fa-print"></i>
            </button>
            
            <div class="relative group">
                <button class="p-2 text-theme-toolbarText hover:bg-white/10 rounded transition">
                    <i class="fa-solid fa-ellipsis-vertical"></i>
                </button>
                <div class="absolute right-0 top-full mt-1 w-48 bg-theme-editor border border-theme-border rounded shadow-lg hidden group-hover:block z-50">
                    <button onclick="copyHTML()" class="w-full text-left px-4 py-2 text-sm text-theme-text hover:bg-theme-base"><i class="fa-solid fa-code w-6"></i> HTMLã‚³ãƒ”ãƒ¼</button>
                    <button onclick="copyMarkdown()" class="w-full text-left px-4 py-2 text-sm text-theme-text hover:bg-theme-base"><i class="fa-solid fa-file-lines w-6"></i> MDã‚³ãƒ”ãƒ¼</button>
                    <div class="border-t border-theme-border my-1"></div>
                    <button onclick="resetEditor()" class="w-full text-left px-4 py-2 text-sm text-red-500 hover:bg-theme-base"><i class="fa-solid fa-trash w-6"></i> å…¨æ¶ˆå»</button>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden relative">
        <div id="editor-container" class="editor-pane w-1/2 flex flex-col border-r border-theme-border bg-theme-editor transition-colors duration-300">
            <textarea id="editor" 
                class="editor-area w-full h-full p-6 resize-none outline-none bg-transparent"
                placeholder="# ã“ã“ã«Markdownã‚’å…¥åŠ›..."
                spellcheck="false"></textarea>
            
            <div id="drop-overlay" class="absolute inset-0 bg-blue-500/20 border-4 border-blue-500 border-dashed m-4 rounded-xl flex items-center justify-center pointer-events-none opacity-0 transition-opacity">
                <div class="text-blue-600 font-bold text-xl bg-white p-4 rounded shadow-lg">
                    <i class="fa-solid fa-image mr-2"></i> ç”»åƒã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦æŒ¿å…¥
                </div>
            </div>
        </div>

        <div id="preview-container" class="preview-pane w-1/2 flex flex-col bg-theme-preview relative transition-colors duration-300">
            <div id="preview" class="markdown-body w-full h-full overflow-y-auto p-8 sm:p-12 pb-24"></div>
        </div>
    </main>

    <footer class="status-bar bg-theme-toolbar border-t border-theme-border text-xs text-theme-muted px-4 py-1 flex justify-between select-none transition-colors duration-300">
        <div class="flex gap-4">
            <span id="line-col-info">Ln 1, Col 1</span>
            <span id="char-count">0 chars</span>
            <span id="word-count">0 words</span>
        </div>
        <div class="flex gap-4">
            <span id="save-status" class="text-green-500 hidden"><i class="fa-solid fa-check"></i> Saved</span>
            <span>Markdown Editor Ultimate</span>
        </div>
    </footer>

    <div id="toast" class="fixed bottom-10 right-10 bg-slate-800 text-white px-5 py-3 rounded-lg shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 pointer-events-none z-50 flex items-center gap-3">
        <i class="fa-solid fa-info-circle"></i>
        <span id="toast-msg">Notification</span>
    </div>

    <script>
        const editor = document.getElementById('editor');
        const preview = document.getElementById('preview');
        const editorContainer = document.getElementById('editor-container');
        const previewContainer = document.getElementById('preview-container');
        const dropOverlay = document.getElementById('drop-overlay');
        const saveStatus = document.getElementById('save-status');
        const highlightLink = document.getElementById('highlight-css');
        const ghCssLink = document.getElementById('github-markdown-css');
        const themeSelector = document.getElementById('theme-selector');

        const defaultText = `# Welcome to Ultimate Editor! ğŸš€

ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ã‚’æ­è¼‰ã—ãŸé«˜æ©Ÿèƒ½ã‚¨ãƒ‡ã‚£ã‚¿ã§ã™ã€‚
å³ä¸Šã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ãƒ†ãƒ¼ãƒã‚’å¤‰æ›´ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

## âœ¨ ãƒ†ãƒ¼ãƒä¸€è¦§

1. **Light**: æ¨™æº–çš„ãªæ˜ã‚‹ã„ãƒ†ãƒ¼ãƒ (ã‚³ãƒ¼ãƒ‰: GitHub Light)
2. **Dark**: GitHubé¢¨ã®ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒ (ã‚³ãƒ¼ãƒ‰: GitHub Dark)
3. **Solarized**: ç›®ã«å„ªã—ã„ã‚¯ãƒªãƒ¼ãƒ è‰²ã®ãƒ†ãƒ¼ãƒ (ã‚³ãƒ¼ãƒ‰: Solarized Light)
4. **Dracula**: äººæ°—ã®ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆå¼·ã‚ã®ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒ (ã‚³ãƒ¼ãƒ‰: Dracula)
5. **Cobalt**: é®®ã‚„ã‹ãªé’èƒŒæ™¯ã®ãƒ†ãƒ¼ãƒ (ã‚³ãƒ¼ãƒ‰: Atom One Dark)

## æ•°å¼ãƒ†ã‚¹ãƒˆ
$$
f(x) = \\int_{-\\infty}^\\infty \\hat f(\\xi)\\,e^{2\\pi i \\xi x} \\,d\\xi
$$

## ã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ©ã‚¤ãƒˆ
\`\`\`javascript
function changeTheme(themeName) {
    document.documentElement.setAttribute('data-theme', themeName);
    console.log("Theme changed to " + themeName);
}
\`\`\`
`;

        marked.setOptions({
            breaks: true,
            gfm: true,
        });

        function init() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            themeSelector.value = savedTheme;
            changeTheme(savedTheme);

            const saved = localStorage.getItem('md_content');
            editor.value = saved !== null ? saved : defaultText;
            
            setViewMode('split');
            updatePreview();
            updateStatus();
            setupSyncScroll();
            setupDragAndDrop();
        }

        function changeTheme(themeName) {
            // 1. CSSå¤‰æ•°åˆ‡ã‚Šæ›¿ãˆ
            document.documentElement.setAttribute('data-theme', themeName);
            localStorage.setItem('theme', themeName);

            // 2. Highlight.js CSSåˆ‡ã‚Šæ›¿ãˆ
            const highlightThemes = {
                'light': 'github',
                'dark': 'github-dark',
                'solarized-light': 'github',
                'dracula': 'github-dark',
                'cobalt': 'github-dark'
            };
            const hlTheme = highlightThemes[themeName] || 'github';
            const newHlHref = `https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/${hlTheme}.min.css`;
            if (highlightLink.href !== newHlHref) {
                highlightLink.href = newHlHref;
            }

            // 3. GitHub Markdown CSSåˆ‡ã‚Šæ›¿ãˆ (Light/Dark)
            // ã“ã‚Œã‚’è¡Œã‚ãªã„ã¨ã€Darkãƒ†ãƒ¼ãƒæ™‚ã«GitHub CSSã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé»’æ–‡å­—ãŒå„ªå…ˆã•ã‚Œã¦è¦‹ãˆãªããªã‚‹
            const isDark = ['dark', 'dracula', 'cobalt'].includes(themeName);
            const ghScheme = isDark ? 'dark' : 'light';
            const newGhHref = `https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.0/github-markdown-${ghScheme}.min.css`;
            
            if (ghCssLink.href !== newGhHref) {
                ghCssLink.href = newGhHref;
            }
        }

        function updatePreview() {
            const raw = editor.value;
            let html = marked.parse(raw);
            
            html = DOMPurify.sanitize(html, {
                ADD_TAGS: ['iframe'], 
                ADD_ATTR: ['allow', 'allowfullscreen', 'frameborder', 'scrolling', 'target']
            });

            preview.innerHTML = html;

            // Highlight.jsé©ç”¨
            preview.querySelectorAll('pre code').forEach((block) => {
                if (!block.classList.contains('language-mermaid')) {
                    hljs.highlightElement(block);
                }
            });

            renderMermaid();

            renderMathInElement(preview, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });

            preview.querySelectorAll('a').forEach(a => a.target = '_blank');
            saveToLocal();
            updateStatus();
        }

        async function renderMermaid() {
            const mermaidBlocks = preview.querySelectorAll('pre code.language-mermaid');
            const nodes = [];
            mermaidBlocks.forEach(block => {
                const pre = block.parentElement;
                const div = document.createElement('div');
                div.className = 'mermaid';
                div.textContent = block.textContent;
                pre.replaceWith(div);
                nodes.push(div);
            });
            if (nodes.length > 0) {
                try {
                    await mermaid.run({ nodes });
                } catch(e) { console.error(e); }
            }
        }

        function updateStatus() {
            const text = editor.value;
            document.getElementById('char-count').innerText = `${text.length} chars`;
            document.getElementById('word-count').innerText = `${text.split(/\s+/).filter(w => w.length > 0).length} words`;
            
            const pos = editor.selectionStart;
            const lines = text.substr(0, pos).split("\n");
            const row = lines.length;
            const col = lines[lines.length - 1].length + 1;
            document.getElementById('line-col-info').innerText = `Ln ${row}, Col ${col}`;
        }

        function insertFormat(type) {
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const text = editor.value;
            const selected = text.substring(start, end);
            let insertText = "";
            let cursorOffset = 0;

            switch(type) {
                case 'bold': insertText = `**${selected || 'å¤ªå­—'}**`; cursorOffset = selected ? 0 : -2; break;
                case 'italic': insertText = `*${selected || 'æ–œä½“'}*`; cursorOffset = selected ? 0 : -1; break;
                case 'strike': insertText = `~~${selected || 'æ‰“ã¡æ¶ˆã—'}~~`; cursorOffset = selected ? 0 : -2; break;
                case 'h1': insertText = `# ${selected || 'è¦‹å‡ºã—1'}`; break;
                case 'h2': insertText = `## ${selected || 'è¦‹å‡ºã—2'}`; break;
                case 'h3': insertText = `### ${selected || 'è¦‹å‡ºã—3'}`; break;
                case 'list': insertText = `- ${selected || 'ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ '}`; break;
                case 'check': insertText = `- [ ] ${selected || 'ã‚¿ã‚¹ã‚¯'}`; break;
                case 'quote': insertText = `> ${selected || 'å¼•ç”¨'}`; break;
                case 'code': insertText = `\`\`\`\n${selected || 'code'}\n\`\`\``; cursorOffset = selected ? 0 : -4; break;
                case 'link': insertText = `[${selected || 'ãƒªãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆ'}](url)`; cursorOffset = -1; break;
                case 'image': insertText = `![${selected || 'ä»£æ›¿ãƒ†ã‚­ã‚¹ãƒˆ'}](image_url)`; cursorOffset = -1; break;
                case 'table': insertText = `| Header 1 | Header 2 |\n| -------- | -------- |\n| Cell 1   | Cell 2   |`; break;
                case 'math': insertText = `$$ ${selected || 'E=mc^2'} $$`; break;
            }

            editor.setRangeText(insertText, start, end, 'select');
            if (cursorOffset !== 0) {
                 editor.selectionStart = editor.selectionEnd + cursorOffset;
                 editor.selectionEnd = editor.selectionStart;
            }
            editor.focus();
            updatePreview();
        }

        function setupDragAndDrop() {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                editor.addEventListener(eventName, preventDefaults, false);
            });
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            editor.addEventListener('dragenter', () => dropOverlay.style.opacity = '1');
            editor.addEventListener('dragleave', (e) => {
                if (!editorContainer.contains(e.relatedTarget)) {
                    dropOverlay.style.opacity = '0';
                }
            });
            editor.addEventListener('drop', handleDrop);
            function handleDrop(e) {
                dropOverlay.style.opacity = '0';
                const dt = e.dataTransfer;
                if(dt.files.length > 0) handleFiles(dt.files);
            }
            function handleFiles(files) {
                const file = files[0];
                if (!file.type.startsWith('image/')) {
                    showToast("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿å¯¾å¿œã—ã¦ã„ã¾ã™", true);
                    return;
                }
                if (file.size > 2 * 1024 * 1024) {
                    if(!confirm("ç”»åƒã‚µã‚¤ã‚ºãŒå¤§ãã„ã§ã™(2MBä»¥ä¸Š)ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ")) return;
                }
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onloadend = function() {
                    const base64data = reader.result;
                    const imgTag = `\n![${file.name}](${base64data})\n`;
                    const start = editor.selectionStart;
                    editor.setRangeText(imgTag, start, start, 'end');
                    updatePreview();
                    showToast("ç”»åƒã‚’æŒ¿å…¥ã—ã¾ã—ãŸ");
                }
            }
        }

        function setViewMode(mode) {
            const btns = document.querySelectorAll('.view-btn');
            btns.forEach(b => b.classList.remove('active'));
            const activeIndex = mode === 'editor' ? 0 : mode === 'split' ? 1 : 2;
            btns[activeIndex].classList.add('active');

            if (mode === 'editor') {
                editorContainer.classList.remove('hidden', 'w-1/2');
                editorContainer.classList.add('w-full');
                previewContainer.classList.add('hidden');
            } else if (mode === 'preview') {
                editorContainer.classList.add('hidden');
                previewContainer.classList.remove('hidden', 'w-1/2');
                previewContainer.classList.add('w-full');
            } else { // split
                editorContainer.classList.remove('hidden', 'w-full');
                editorContainer.classList.add('w-1/2');
                previewContainer.classList.remove('hidden', 'w-full');
                previewContainer.classList.add('w-1/2');
            }
        }

        function exportPDF() { window.print(); }

        function setupSyncScroll() {
            let isScrolling = false;
            editor.addEventListener('scroll', () => {
                if (!isScrolling && !editorContainer.classList.contains('hidden') && !previewContainer.classList.contains('hidden')) {
                    window.requestAnimationFrame(() => {
                        const percent = editor.scrollTop / (editor.scrollHeight - editor.clientHeight);
                        preview.scrollTop = percent * (preview.scrollHeight - preview.clientHeight);
                    });
                }
            });
        }
        
        function saveToLocal() {
            localStorage.setItem('md_content', editor.value);
            saveStatus.classList.remove('hidden');
            setTimeout(() => saveStatus.classList.add('hidden'), 2000);
        }

        editor.addEventListener('input', updatePreview);
        editor.addEventListener('keyup', updateStatus);
        editor.addEventListener('click', updateStatus);

        async function copyToClipboard(text, msg) {
            try { await navigator.clipboard.writeText(text); showToast(msg); }
            catch(e) { showToast("Error", true); }
        }
        function copyHTML() { copyToClipboard(preview.innerHTML, "HTML Copied!"); }
        function copyMarkdown() { copyToClipboard(editor.value, "Markdown Copied!"); }
        function resetEditor() { 
            if(confirm("å…¨ã¦æ¶ˆå»ã—ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) { 
                editor.value = ""; 
                updatePreview(); 
                showToast("Reset Complete"); 
            } 
        }

        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            toast.classList.remove('translate-y-20', 'opacity-0');
            if(isError) toast.classList.add('bg-red-600');
            else toast.classList.remove('bg-red-600');
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 2500);
        }

        init();
    </script>
</body>
</html>
